<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="UTF-8">
		<title>TradingView Advanced Charts demo</title>

		<!-- Fix for iOS Safari zooming bug -->
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">

		<script type="text/javascript" src="charting_library/charting_library.standalone.js"></script>
		<script type="text/javascript" src="datafeeds/udf/dist/bundle.js"></script>
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<!-- DataTables CSS -->
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
		<!-- DataTables JS -->
    	<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
		<!-- dialog JS -->
		<link href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css" rel="stylesheet">
		<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
<!--		<script src="https://raw.githubusercontent.com/ROMB/jquery-dialogextend/master/build/jquery.dialogextend.js"></script>-->
		<style>
			#popup {
				display: none;
				position: fixed;
				top: 60px;
				right: 20px;
				padding: 40px;
				background-color: #f8f9fa;
				border: 1px solid #ced4da;
				border-radius: 8px;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			}
			#myTable input{
				width: 100%;
			}
			#cijiChanTable td{
				border: 1px solid;
				padding: 2px; /* è®¾ç½®å•å…ƒæ ¼å†…å®¹çš„å¡«å……ç©ºé—´ */
            	text-align: center; /* è®¾ç½®æ–‡æœ¬å¯¹é½æ–¹å¼ */
			}
			#cijiChanDiv{
				position: absolute;
				top: 0;
				left: 1010px;
				z-index: 1000;
				background-color: #dec66d;
				color: white;
				border: none;
				padding: 3px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
			}
			#calender{
				position: absolute;
				top: 0;
				left: 468px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 3px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
			}
			#topVolume{
				position: absolute;
				top: 0;
				left: 1132px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			#third_flag{
				position: absolute;
				top: 0;
				left: 820px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			#thirdBS{
				position: absolute;
				top: 0;
				left: 946px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			#chanThoery {
				position: absolute;
				top: 0;
				left: 888px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			.ui-dialog-titlebar-max{
				position: absolute;
				right: 66px;
				background-color: #e9e9e9;
				color: #000000;
				border: none;
				cursor: pointer;
			}
			.ui-dialog-titlebar-reset{
				position: absolute;
				right: 32px;
				background-color: #e9e9e9;
				color: #000000;
				border: none;
				cursor: pointer;
			}
			.ui-dialog-titlebar-min{
				position: absolute;
				right: 96px;
				background-color: #e9e9e9;
				color: #000000;
				border: none;
				cursor: pointer;
			}
		</style>

		<script type="text/javascript">
			var chanLun_lines=[];
			const baseUrl='http://127.0.0.1:8001';
			var hot_stock_uri = '/hot_stock?datetimeGT=2025-05-02';
			var focus_on_uri = '/focus_on?resolution=1d&datetimeGT=2025-05-02&datetimeET=2025-05-12';
			var thirdBS_uri = "/third_bs_query?datetimeGT=2025-05-01&datetimeET=2025-05-13&resolution=1D";
			var thirdBSTableObj=null, thirdCijiTableObj=null, thirdBSTableStyle=null ;
			var cijiChanTable = [], cijiChanTableIndex = -1;
			const is_confirm_type={
				0:'ç­›é€‰',
				1:'ç¡®è®¤',
				2:'å–æ¶ˆ',
			}
			 $(document).ready(function() {
				 $("#calendar1").datepicker({
					 dateFormat: "yy-mm-dd", // æ ¼å¼åŒ–ä¸º2024-06-30
					 // defaultDate: new Date(),
					 showButtonPanel:false,
					 onClose: function (dateText, inst){
						 var tt=$("#calendar2").val();
						 hot_stock_uri = '/hot_stock?datetimeGT='+dateText+"&datetimeET="+tt;
					 }
				 });
				 $("#calendar2").datepicker({
					 dateFormat: "yy-mm-dd", // æ ¼å¼åŒ–ä¸º2024-06-30
					 // defaultDate: new Date(),
					 showButtonPanel:true,
					 onClose: function (dateText, inst){
						 const d=new Date(dateText).getTime()-1*24*3600*1000
						 var last2day = $.datepicker.formatDate('yy-mm-dd', new Date(d));
						 $("#calendar1").val(last2day);
						 hot_stock_uri = '/hot_stock?datetimeGT='+last2day+"&datetimeET="+dateText;
					 }
				 });
				 var today = $.datepicker.formatDate('yy-mm-dd', new Date());
				 $("#calendar2").val(today);
				 const t=new Date().getTime()-2*24*3600*1000;
				 var last2day = $.datepicker.formatDate('yy-mm-dd', new Date(t));
				 $("#calendar1").val(last2day);
				 hot_stock_uri = '/hot_stock?datetimeGT='+last2day+"&datetimeET="+today;

				 // æ¬¡çº§ä¸‰ä¹°
				 $("#thirdCijiDiv").dialog({
					 modal: false,
					 autoOpen: false,
					 width: 1400,
					 height: 700,
				 });
				 thirdCijiTableObj = $('#thirdCijiTable').DataTable({
					 ajax: {
						 url: baseUrl + focus_on_uri,   // ä½ çš„åç«¯æ•°æ®æ¥å£åœ°å€
						 dataSrc: function (json) {
							 cijiChanTable = json.data; // å°†æ•°æ®ä¿å­˜åˆ°å…¨å±€å˜é‡
							 return json.data; // è¿”å›ç»™ DataTable è¿›è¡Œæ¸²æŸ“
						 }
					 },
					 columns: [
						 {
							 "data": null,
							 "width": '30px',
							 "render": function (data, type, row, meta) {
								 return meta.row + 1;
							 }
						 },
						 {data: 'code'},
						 { data: 'starttime',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd')
							}
						},
						 { data: 'endtime',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd')
							}
						},
						 {data: 'high'},
						 {data: 'low'},
						 { data: 'focus_time',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd')
							}
						 },
						 {data: 'focus_price'},
						 {data: 'focus_type'},
						 {data: 'is_confirm',render: function(data, type, row) {
								return is_confirm_type[data];
							}
						 },
						 {
							"data": null,
							"title": "æ“ä½œ", // å¯é€‰ï¼Œè¡¨å¤´è‡ªå®šä¹‰
							"orderable": false, // ä¸æ’åº
							"render": function(data, type, row, meta){
								// data/row å°±æ˜¯å½“å‰è¡Œçš„æ•°æ®
								var index = meta.row+1;
								// å‡è®¾rowæœ‰idä¸»é”®
								return '<button class="thirdBS-btn-item" data-index="'+index+'" data-id="'+row.code+'">æŸ¥çœ‹</button>'
										+'<button class="thirdBS-btn-confirm" data-id2="'+row.focus_time+'" data-id="'+row.code+'">ç¡®å®š</button>'
										+'<button class="thirdBS-btn-cancel" data-id2="'+row.focus_time+'"  data-id="'+row.code+'">å–æ¶ˆ</button>';
							}
						 }
					 ]
				 })
				 //ä¸‰ä¹°å–çª—å£
				 $("#thirdBSDiv").dialog({
					 modal: false,
					 autoOpen: false,
					 width: 1400,
					 height: 700,
					 create: function(event, ui) {
						var dialog = $(this).closest(".ui-dialog");
						// æœ€ä¸‹åŒ–æŒ‰é’®
						$("<button class='ui-dialog-titlebar-min'><span style='font-weight: bold;'>â€”</span></button>")
						  .appendTo(dialog.find(".ui-dialog-titlebar"))
						  .click(function() {
							  thirdBSTableStyle = dialog.attr('style');
							  dialog.css({ height: "42px" });
							  dialog.find(".ui-dialog-content").css({ height: "calc(0%)" });
							  dialog.find(".ui-dialog-content").css({ padding: "0" });
						  });
						// æ·»åŠ æœ€å¤§åŒ–æŒ‰é’®
						$("<button class='ui-dialog-titlebar-max'>ğŸ—–</button>")
						  .appendTo(dialog.find(".ui-dialog-titlebar"))
						  .click(function() {
							  dialog.css({ width: "100%", height: "100%", top: 0, left: 0 });
							  dialog.find(".ui-dialog-content").css({ height: "100%", width:'100%' });
							  dialog.find(".ui-dialog-content").css({ padding: "2px 1em" });
						  });
						//å¤åŸçª—å£ æŒ‰é’®
						$("<button class='ui-dialog-titlebar-reset'>â</button>")
						  .appendTo(dialog.find(".ui-dialog-titlebar"))
						  .click(function() {
							  dialog.attr('style', thirdBSTableStyle);
							  // dialog.css({height: "700px", width: "1400px",top: "19px", left: "60px" });
							  dialog.find(".ui-dialog-content").css({ height: "100%", width:'100%' });
							  dialog.find(".ui-dialog-content").css({ padding: "2px 1em" });
						  });

					 }
				 })
				 thirdBSTableObj = $('#thirdBSTable').DataTable({
					 ajax: {
						 url: baseUrl + thirdBS_uri,   // ä½ çš„åç«¯æ•°æ®æ¥å£åœ°å€
						 // dataSrc: ''              // å‡å¦‚è¿”å›çš„æ˜¯æ•°ç»„ï¼Œä¸æ˜¯å¯¹è±¡æœ€å¤–å±‚dataæ‰è¿™æ ·å†™
					 },
					 columns: [
						 {
							 "data": null,
							 "width": '30px',
							 "render": function(data, type, row, meta){
							  	return meta.row+1;
							 }
						 },
						 {data: 'Ticker'},
						 { data: 'startDate',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd HH:mm')
							}
						},
						 { data: 'endDate',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd HH:mm')
							}
						},
						 {data: 'Line_Type'},
						 {data: 'class_type'},
						 {data: 'endPrice'},
						 {data: 'rate'},
						 {
							"data": null,
							"title": "æ“ä½œ", // å¯é€‰ï¼Œè¡¨å¤´è‡ªå®šä¹‰
							"orderable": false, // ä¸æ’åº
							"render": function(data, type, row, meta){
								// data/row å°±æ˜¯å½“å‰è¡Œçš„æ•°æ®
								// å‡è®¾rowæœ‰idä¸»é”®
								return '<button class="thirdBS-btn" data-id="'+row.Ticker+'">æŸ¥çœ‹</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="0">0</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="1">1</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="2">2</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="3">3</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="4">4</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="5">5</button>';
							}
						}

					 ],
					 processing: true, // å¼€å¯DataTableså†…ç½®çš„â€œæ­£åœ¨å¤„ç†...â€åŠ¨ç”»
					 language: {
						processing: "æ•°æ®åŠ è½½ä¸­..." // å¯è‡ªå®šä¹‰æ–‡å­—
					 }
				 });
				 var minFilter = { 2: null, 3: null, 4: null, 5: null,6: null, 7: null, 8: null}; // é”®ä¸ºè¡¨çš„åˆ—ä¸‹æ ‡
				 $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
					// éå†æœ‰filterçš„åˆ—
					for(var col in minFilter){
						var minValue = minFilter[col];
						if(minValue !== null && minValue !== ''){
							// data[col] æ˜¯è¡¨æ ¼å½“å‰æ¸²æŸ“è¡Œçš„æŒ‡å®šåˆ—ï¼Œé€šå¸¸è¢«æ¸²æŸ“åå¸¦é€—å·è¦å»æ‰
							var cellValue = Number(data[col].replace(/,/g,''));
							if (isNaN(cellValue) || cellValue <= Number(minValue)) {
								return false; // ä¸é€šè¿‡ç­›é€‰
							}
						}
					}
					return true; // å…¨éƒ¨é€šè¿‡
				});

				 // ç›‘å¬ä¸‰ä¸ªåˆ—çš„è¾“å…¥ï¼ˆVolume=ç¬¬2åˆ—ï¼ŒMA5=ç¬¬3åˆ—ï¼ŒMA10=ç¬¬4åˆ—ï¼‰
				 $('#myTable thead tr:eq(0) th').each(function(i) {
					var $input = $('input', this);
					if ($input.length) {
						$input.on('keyup change', function() {
							// æŠŠç›¸åº”åˆ—çš„æœ€å°å€¼è®°å½•ä¸‹æ¥
							minFilter[i] = cleanNumber(this.value);
							myTableObj.draw();
						});
					}
				});
				 $(document).on('click', '.edit-btn', function(){
					var id = $(this).data('id');
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					var chart = window.tvWidget.activeChart();
					chart.setSymbol(id)
					 chart.setResolution('1D')
					 $("#hotStock").dialog('close');
				 });
				 $(document).on('click', '.thirdBS-btn', function(){
					var id = $(this).data('id');
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					var chart = window.tvWidget.activeChart();
					chart.setSymbol(id);
					$("#hotStock").dialog('close');
				 });
				 $(document).on('click', '.thirdBS-btn-rate', function(){
					var id = $(this).data('id');
					var linetype = $(this).data('linetype');
					var startDate = $(this).data('startdate') / 1000;
					var rate = $(this).data('rate');
					var chart = window.tvWidget.activeChart();
					const resolution = chart.resolution();
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					 $.ajax({
						 url: baseUrl + '/chan_rate',
						 type: 'GET',
						 dataType: 'json', // æŒ‡å®šè¿”å›æ•°æ®ç±»å‹ä¸º JSON
						 data: {
							 resolution: resolution,
							 symbol: id,
							 line_type: linetype,
							 start_date: startDate,
							 rate: rate
						 },
						 success: function (response) {
							 $('#popup').html('æ›´æ–°å…³æ³¨åº¦ï¼ŒæˆåŠŸï¼');
							 $('#popup').fadeIn();
							 // è®¾å®š3ç§’åè‡ªåŠ¨å…³é—­
							 setTimeout(function() {
								 $('#popup').fadeOut();
								 thirdBSTableObj.ajax.url(baseUrl + thirdBS_uri).load();
							 }, 500);
						 },
						 error: function () {
						 }
					 });

				 });
				 $(document).on('click', '.thirdBS-btn-confirm', function(){
					var id = $(this).data('id');
					var focus_time = $(this).data('id2')/1000;
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					 $.ajax({
						 url: baseUrl + '/focus_on_confirm',
						 type: 'GET',
						 dataType: 'json', // æŒ‡å®šè¿”å›æ•°æ®ç±»å‹ä¸º JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 $('#popup').html('ç¡®è®¤æˆåŠŸï¼');
							 $('#popup').fadeIn();
							 // è®¾å®š3ç§’åè‡ªåŠ¨å…³é—­
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
							 thirdCijiTableObj.ajax.url(baseUrl + focus_on_uri).load();
						 },
						 error: function () {
						 }
					 });
				 });
				 $(document).on('click', '.thirdBS-btn-cancel', function(){
					var id = $(this).data('id');
					var focus_time = $(this).data('id2')/1000;
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					 $.ajax({
						 url: baseUrl + '/focus_on_cancel',
						 type: 'GET',
						 dataType: 'json', // æŒ‡å®šè¿”å›æ•°æ®ç±»å‹ä¸º JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 $('#popup').html('å–æ¶ˆæˆåŠŸï¼');
							 $('#popup').fadeIn();
							 // è®¾å®š3ç§’åè‡ªåŠ¨å…³é—­
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
							 thirdCijiTableObj.ajax.url(baseUrl + focus_on_uri).load();
						 },
						 error: function () {
						 }
					 });
				 });

				 $(document).on('click', '.thirdBS-btn-item', function(){
					 var id = $(this).data('id');
					 var index = $(this).data('index');
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					var chart = window.tvWidget.activeChart();
					chart.setSymbol(id);
					cijiChanTableIndex = index-1;
					renderCijiChanItem();
				 });
				 $(document).on('click', '.thirdBS-btn-item-preview', function(){
					 cijiChanTableIndex--;
					 if(cijiChanTableIndex<0){
						 cijiChanTableIndex=0;
						 return ;
					 }
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 // ä½ çš„ç¼–è¾‘é€»è¾‘
					 var chart = window.tvWidget.activeChart();
					 chart.setSymbol(id);
					 renderCijiChanItem();
					 //ç»˜åˆ¶ç¼ è®ºçº¿
					 setTimeout(function(){
						 const resolution = chart.resolution();
						 var symbol = id;
						 console.info(resolution,symbol);
						 clearAllLines(chart);
						 drawLines(chart, symbol, resolution);
					 }, 2000);
				 });
				 $(document).on('click', '.thirdBS-btn-item-confirm', function(){
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 var focus_time = item.focus_time/1000;
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					 $.ajax({
						 url: baseUrl + '/focus_on_confirm',
						 type: 'GET',
						 dataType: 'json', // æŒ‡å®šè¿”å›æ•°æ®ç±»å‹ä¸º JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 $('#popup').html('ç¡®è®¤æˆåŠŸï¼');
							 $('#popup').fadeIn();
							 // è®¾å®š3ç§’åè‡ªåŠ¨å…³é—­
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
						 },
						 error: function () {
						 }
					 });
				 });
				 $(document).on('click', '.thirdBS-btn-item-cancel', function(){
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 var focus_time = item.focus_time/1000;
					// ä½ çš„ç¼–è¾‘é€»è¾‘
					 $.ajax({
						 url: baseUrl + '/focus_on_cancel',
						 type: 'GET',
						 dataType: 'json', // æŒ‡å®šè¿”å›æ•°æ®ç±»å‹ä¸º JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 // alert("å–æ¶ˆæˆåŠŸï¼")
							 $('#popup').html('å–æ¶ˆæˆåŠŸï¼');
							 $('#popup').fadeIn();
							 // è®¾å®š3ç§’åè‡ªåŠ¨å…³é—­
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
						 },
						 error: function () {
						 }
					 });
				 });
				 $(document).on('click', '.thirdBS-btn-item-next', function(){
					 cijiChanTableIndex++;
					 if(cijiChanTableIndex>=cijiChanTable.length){
						 cijiChanTableIndex=cijiChanTable.length-1;
						 return ;
					 }
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 // ä½ çš„ç¼–è¾‘é€»è¾‘
					 var chart = window.tvWidget.activeChart();
					 chart.setSymbol(id);
					 renderCijiChanItem();
					 //ç»˜åˆ¶ç¼ è®ºçº¿
					 setTimeout(function(){
						 const resolution = chart.resolution();
						 var symbol = id;
						 console.info(resolution,symbol);
						 clearAllLines(chart);
						 drawLines(chart, symbol, resolution);
					 }, 2000);
				 });
			 })
			function formatDate(date, format) {
				if (!(date instanceof Date)) {
					date = new Date(date); // æ”¯æŒæ—¶é—´æˆ³æˆ–å­—ç¬¦ä¸²
				}
				const map = {
					'yyyy': date.getFullYear(),
					'MM': ('0' + (date.getMonth() + 1)).slice(-2),
					'dd': ('0' + date.getDate()).slice(-2),
					'HH': ('0' + date.getHours()).slice(-2),
					'mm': ('0' + date.getMinutes()).slice(-2),
					'ss': ('0' + date.getSeconds()).slice(-2)
				};
				return format.replace(/yyyy|MM|dd|HH|mm|ss/g, (key) => map[key]);
			}
			function cleanNumber(str) {
			  // å»é™¤æ‰€æœ‰ç©ºæ ¼å’Œé€—å·
			  var cleaned = str.replace(/[\s,]/g, '');
			  // è½¬æˆæ•°å­—
			  return Number(cleaned);
			}
			function getParameterByName(name) {
				name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
				var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
					results = regex.exec(location.search);
				return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			function clearAllLines(chart){
				for(var id in chanLun_lines){
					if(chanLun_lines[id]==null){
						continue
					}
					chart.removeEntity(chanLun_lines[id]);
				}
                chanLun_lines = []
			}
			function createText(chart, time, price, text){
				 var id = chart.createShape(
					  {
						time: time, // æ—¶é—´æˆ³/æˆ–barç´¢å¼•
						price: price,       // ä»·æ ¼
					  },
					  {
						shape: 'text',
						text: text,//'ä¸‰ä¹°ä¿¡å·',
						lock: true,
					  }
					)
				 if(id){
					 chanLun_lines.push(id);
				 }
			}
			function drawLines(chart, symbol, resolution){
				$.ajax({
					url: baseUrl+'/chan',
					type: 'GET',
					dataType: 'json', // æŒ‡å®šè¿”å›æ•°æ®ç±»å‹ä¸º JSON
					data: {
						symbol: symbol,
						resolution: resolution
					},
					success: function(response) {
						// chart.removeAllStudies();
						// chart.removeEntity(test);
						// console.log('Success:', response);
						for(var i in response){
							const item = response[i];
							if (item.class_type){
								if(item.class_type=='Third Buy'){
									if(item.Line_Type == 'down'){
										createText(chart, item.endDate, item.endPrice, item.class_type);
									}else{
										createText(chart, item.startDate, item.startPrice, item.class_type);
									}
								}
								if(item.class_type=='Third Sell'){
									if(item.Line_Type == 'up'){
										createText(chart, item.endDate, item.endPrice, item.class_type);
									}else{
										createText(chart, item.startDate, item.startPrice, item.class_type);
									}
								}
								if (item.class_type=='First Sell' || item.class_type=='First Buy'){
									createText(chart, item.endDate, item.endPrice, item.class_type);
								}
							}
							var lineId = chart.createMultipointShape(
							  [
								{ time: item.startDate, price: item.startPrice },
								{ time: item.endDate, price: item.endPrice },
							  ],
							  {
								shape: 'trend_line',
								overrides: {
								  linecolor: '#FF0000',
								  linewidth: 2,
								},
								lock: true,
								disableSelection: true,
								disableSave: true,
								disableUndo: true,
								text: item.Line_Type,
							  });
							chanLun_lines.push(lineId);
						}
					},
					error: function(xhr, status, error) {
						console.error('Error:', error);
					}
				});
			}
			function renderCijiChanItem(){
				if(cijiChanTableIndex>-1){
					var item = cijiChanTable[cijiChanTableIndex];
					if(item){
						var trs = $("#cijiChanTable");
						trs.html("");
						const colume_list = [
								{"name":"code", "type": 'string'},
								{"name":"focus_time", "type": 'date'},
								{"name":"period", "type": 'string'},
								{"name":"is_confirm", "type": 'emun'}
						];
						for(var i in colume_list){
							var key = colume_list[i].name;
							var type= colume_list[i].type;
							var value = item[key]
							if(type == 'date'){
								value = formatDate(value, 'yyyy-MM-dd')
							}else if(type == 'emun'){
								value = is_confirm_type[value];
							}
							var td = $("<td>").html(value);
							trs.append(td);
						}
						var count = "&nbsp; "+(cijiChanTableIndex+1)+"/"+cijiChanTable.length
						var td=$("<td>").html(count);
						trs.append(td);
					}
				}
			}
			function initOnReady() {
				console.info(TradingView.version());
				var datafeedUrl = baseUrl;//"http://127.0.0.1:8000";
				// var datafeedUrl = "https://demo-feed-data.tradingview.com";
				var customDataUrl = getParameterByName('dataUrl');
				if (customDataUrl !== "") {
					datafeedUrl = customDataUrl.startsWith('https://') ? customDataUrl : `https://${customDataUrl}`;
				}

				var widget = window.tvWidget = new TradingView.widget({
					// debug: true, // uncomment this line to see Library errors and warnings in the console
					fullscreen: true,
					symbol: 'sh.000001',
					// interval: '5',
					interval: '1D',
					container: "tv_chart_container",

					//	BEWARE: no trailing slash is expected in feed URL
					datafeed: new Datafeeds.UDFCompatibleDatafeed(datafeedUrl, undefined, {
						maxResponseLength: 1000,
						expectedOrder: 'latestFirst',
					}),
					library_path: "charting_library/",
					locale: getParameterByName('lang') || "en",
					timezone: "UTC",
					time_scale: {
						timeVisible: true,
						secondsVisible: true,
					},
					// disabled_features: ["use_localstorage_for_settings"],
					disabled_features: [],
					enabled_features: ["study_templates","use_localstorage_for_settings"],
					// charts_storage_url: 'https://saveload.tradingview.com',
					charts_storage_api_version: "1.1",
					client_id: 'tradingview.com',
					user_id: 'public_user_id',
					theme: getParameterByName('theme'),
					debug: false,
					// debug: true,
					// æ—¶é—´æ ¼å¼åŒ–
					custom_formatters: {
						timeFormatter: { //åˆ†é’Ÿæ ¼å¼åŒ–
							format: (date) => {
								const _format_str = '%h:%m';
								return _format_str
										.replace('%h', date.getUTCHours(), 2)
										.replace('%m', date.getUTCMinutes(), 2)
										.replace('%s', date.getUTCSeconds(), 2);
							}
						},
						dateFormatter: { //å¹´æœˆæ—¥æ ¼å¼åŒ–
							format: (date) => {
								return date.getUTCFullYear() + '/' + (date.getUTCMonth() + 1) + '/' + date.getUTCDate();
							}
						},
					},
					context_menu: {
						items_processor: function(items, actionsFactory, params) {
							 console.log(`Menu name is:`);
							 const newItem = actionsFactory.createAction({
								actionId: 'hello-world',
								label: 'Say Hello',
								onExecute: function() {
								   alert('Hello World');
								},
							 });
							 items.unshift(newItem);
							 return Promise.resolve(items);
						},
				    }
				});
				widget.onChartReady(() => {
					console.info("dzm");
					const chart = widget.activeChart(); // å‡è®¾ widget æ˜¯ä½ çš„ Charting Library å®ä¾‹
					/*
					const startTime = Math.floor(new Date('2025-01-22T00:00:00Z').getTime() / 1000);
					const endTime = Math.floor(new Date('2025-03-01T00:00:00Z').getTime() / 1000);

					// åˆ›å»ºçº¿æ®µ
					var test = chart.createMultipointShape(
					  [
						{ time: startTime, price: 200 },
						{ time: endTime, price: 212 },
					  ],
					  {
						shape: 'trend_line',
						overrides: {
						  linecolor: '#FF0000',
						  linewidth: 2,
						},
						lock: true,
						disableSelection: true,
						disableSave: true,
						disableUndo: true,
						text: "text",
					  })*/
				  // widget.activeChart().setResolution('5');  // æ˜¾å¼è®¾ç½®ä¸º 5 åˆ†é’Ÿ
					//add chanThoeryButton
					const chartContainer = document.getElementById('tv_chart_container');
					//---------------------æ¬¡çº§ä¸‰ä¹°-----------------------
					const third_flag = document.createElement('button');
					third_flag.id = 'third_flag';
					third_flag.innerText = 'æ¬¡çº§ä¸‰ä¹°';
					chartContainer.appendChild(third_flag);
					third_flag.addEventListener('click', function() {
						var last2day = $("#calendar1").val();
						var tt=$("#calendar2").val();
						const resolution = chart.resolution();
						focus_on_uri = '/focus_on?datetimeGT='+last2day+"&datetimeET="+tt+"&resolution="+resolution;
						thirdCijiTableObj.ajax.url(baseUrl + focus_on_uri).load();
						$("#thirdCijiDiv").dialog('open');
						cijiChanTableIndex = 0;
						renderCijiChanItem();
					});
					// --------------------ä¸‰ä¹°/å–--------------------
					const thirdBS = document.createElement('button');
					thirdBS.id = 'thirdBS';
					thirdBS.innerText = 'ä¸‰ä¹°/å–';
					chartContainer.appendChild(thirdBS);
					thirdBS.addEventListener('click', function() {
						var last2day = $("#calendar1").val();
						var tt=$("#calendar2").val();
						const resolution = chart.resolution();
						var symbol = chart.symbol();
						symbol = symbol.split(":")[1];
						// console.info(resolution,symbol);
						thirdBS_uri = '/third_bs_query?datetimeGT='+last2day+"&datetimeET="+tt+"&resolution="+resolution;
						thirdBSTableObj.ajax.url(baseUrl + thirdBS_uri).load();
						$("#thirdBSDiv").dialog('open');
						// myTableObj.ajax.reload();
					})
					// --------------------ç¼ è®º-çº¿--------------------
					const button = document.createElement('button');
					button.id = 'chanThoery';
					button.innerText = 'ç¼ è®º-çº¿';
					// button.style.position = 'absolute';
					// button.style.top = '10px';
					// button.style.right = '10px';

					// æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
					button.addEventListener('click', function() {
						const resolution = chart.resolution();
						var symbol = chart.symbol();
						if (symbol.indexOf(":")){
							symbol = symbol.split(":")[1]
						}
						console.info(resolution,symbol);
						clearAllLines(chart);

						drawLines(chart, symbol, resolution);
					});
					chartContainer.appendChild(button);
				});
			};


			window.addEventListener('DOMContentLoaded', initOnReady, false);
		</script>

	</head>

	<body style="margin:0px;">
		<div id="tv_chart_container"></div>
		<div id="calender">
			å¼€å§‹æ—¶é—´ï¼š
			<input type="text" id="calendar1" style="width:88px">
			ç»“æŸæ—¶é—´ï¼š
			<input type="text" id="calendar2" style="width:88px">
		</div>
		<div id="cijiChanDiv">
			<table style="border-collapse: collapse;float: left">
				<tr id="cijiChanTable">
					<td>æ¬¡çº§ä¸‰ä¹°æ“ä½œåŒº</td>
				</tr>
			</table>
			<table style="border-collapse: collapse;float: right">
				<tr>
					<td><button class="thirdBS-btn-item-preview">ã€Š&nbsp;</button></td>
					<td><button class="thirdBS-btn-item-confirm">ç¡®å®š&nbsp;</button></td>
					<td><button class="thirdBS-btn-item-cancel">å–æ¶ˆ</button></td>
					<td><button class="thirdBS-btn-item-next">&nbsp;ã€‹</button></td>
				</tr>
			</table>
		</div>
		<div id="thirdBSDiv" title="ä¸‰ä¹°/å–" style="display:none;padding: 1px 1em">
			  <div style="background-color: #fff">
				  <table id="thirdBSTable" class="display" width="100%">
					  <thead>
						<tr>
							<th>åºå·</th>
							<th>ä»£ç </th>
							<th>å¼€å§‹æ—¶é—´</th>
							<th>ç»“æŸæ—¶é—´</th>
							<th>çº¿æ®µç±»å‹</th>
							<th>ä¹°å–ç±»å‹</th>
							<th>ç»“æŸä»·æ ¼</th>
							<th><span title="é‡è¦ç¨‹åº¦:0-5">é‡è¦åº¦</span></th>
							<th>æ“ä½œ</th>
						</tr>
					</thead>
					<tbody>
						<!-- Ajax æ¸²æŸ“ï¼Œè¿™é‡Œå¯ä»¥ç•™ç©º -->
					</tbody>
				  </table>
			  </div>
			</div>
		<div id="thirdCijiDiv" title="æ¬¡çº§ä¸‰ä¹°" style="display:none;">
			  <div style="background-color: #fff">
				  <table id="thirdCijiTable" class="display" width="100%">
					  <thead>
						<tr>
							<th>åºå·</th>
							<th>ä»£ç </th>
							<th>åŒºé—´å¼€å§‹</th>
							<th>åŒºé—´ç»“æŸ</th>
							<th>åŒºé—´é¡¶</th>
							<th>åŒºé—´åº•</th>
							<th>å…³æ³¨æ—¶é—´</th>
							<th>å…³æ³¨ä»·æ ¼</th>
							<th>ç±»å‹</th>
							<th>æ˜ç¡®</th>
							<th>æ“ä½œ</th>
						</tr>
					</thead>
					<tbody>
						<!-- Ajax æ¸²æŸ“ï¼Œè¿™é‡Œå¯ä»¥ç•™ç©º -->
					</tbody>
				  </table>
			  </div>
			</div>
		<div id="popup" style="z-index: 1002">è¿™æ˜¯ä¸€ä¸ªå³ä¸‹è§’å¼¹çª—ï¼</div>
	</body>

</html>
