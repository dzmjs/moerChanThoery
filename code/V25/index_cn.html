<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="UTF-8">
		<title>TradingView Advanced Charts demo</title>

		<!-- Fix for iOS Safari zooming bug -->
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">

		<script type="text/javascript" src="charting_library/charting_library.standalone.js"></script>
		<script type="text/javascript" src="datafeeds/udf/dist/bundle.js"></script>
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<!-- DataTables CSS -->
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
		<!-- DataTables JS -->
    	<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
		<!-- dialog JS -->
		<link href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css" rel="stylesheet">
		<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
<!--		<script src="https://raw.githubusercontent.com/ROMB/jquery-dialogextend/master/build/jquery.dialogextend.js"></script>-->
		<style>
			#popup {
				display: none;
				position: fixed;
				top: 60px;
				right: 20px;
				padding: 40px;
				background-color: #f8f9fa;
				border: 1px solid #ced4da;
				border-radius: 8px;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			}
			#myTable input{
				width: 100%;
			}
			#cijiChanTable td{
				border: 1px solid;
				padding: 2px; /* 设置单元格内容的填充空间 */
            	text-align: center; /* 设置文本对齐方式 */
			}
			#cijiChanDiv{
				position: absolute;
				top: 0;
				left: 1010px;
				z-index: 1000;
				background-color: #dec66d;
				color: white;
				border: none;
				padding: 3px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
			}
			#calender{
				position: absolute;
				top: 0;
				left: 468px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 3px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
			}
			#topVolume{
				position: absolute;
				top: 0;
				left: 1132px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			#third_flag{
				position: absolute;
				top: 0;
				left: 820px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			#thirdBS{
				position: absolute;
				top: 0;
				left: 946px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			#chanThoery {
				position: absolute;
				top: 0;
				left: 888px;
				z-index: 1000;
				background-color: #4CAF50;
				color: white;
				border: none;
				padding: 5px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 14px;
				margin: 4px;
				cursor: pointer;
			}
			.ui-dialog-titlebar-max{
				position: absolute;
				right: 66px;
				background-color: #e9e9e9;
				color: #000000;
				border: none;
				cursor: pointer;
			}
			.ui-dialog-titlebar-reset{
				position: absolute;
				right: 32px;
				background-color: #e9e9e9;
				color: #000000;
				border: none;
				cursor: pointer;
			}
			.ui-dialog-titlebar-min{
				position: absolute;
				right: 96px;
				background-color: #e9e9e9;
				color: #000000;
				border: none;
				cursor: pointer;
			}
		</style>

		<script type="text/javascript">
			var chanLun_lines=[];
			const baseUrl='http://127.0.0.1:8001';
			var hot_stock_uri = '/hot_stock?datetimeGT=2025-05-02';
			var focus_on_uri = '/focus_on?resolution=1d&datetimeGT=2025-05-02&datetimeET=2025-05-12';
			var thirdBS_uri = "/third_bs_query?datetimeGT=2025-05-01&datetimeET=2025-05-13&resolution=1D";
			var thirdBSTableObj=null, thirdCijiTableObj=null, thirdBSTableStyle=null ;
			var cijiChanTable = [], cijiChanTableIndex = -1;
			const is_confirm_type={
				0:'筛选',
				1:'确认',
				2:'取消',
			}
			 $(document).ready(function() {
				 $("#calendar1").datepicker({
					 dateFormat: "yy-mm-dd", // 格式化为2024-06-30
					 // defaultDate: new Date(),
					 showButtonPanel:false,
					 onClose: function (dateText, inst){
						 var tt=$("#calendar2").val();
						 hot_stock_uri = '/hot_stock?datetimeGT='+dateText+"&datetimeET="+tt;
					 }
				 });
				 $("#calendar2").datepicker({
					 dateFormat: "yy-mm-dd", // 格式化为2024-06-30
					 // defaultDate: new Date(),
					 showButtonPanel:true,
					 onClose: function (dateText, inst){
						 const d=new Date(dateText).getTime()-1*24*3600*1000
						 var last2day = $.datepicker.formatDate('yy-mm-dd', new Date(d));
						 $("#calendar1").val(last2day);
						 hot_stock_uri = '/hot_stock?datetimeGT='+last2day+"&datetimeET="+dateText;
					 }
				 });
				 var today = $.datepicker.formatDate('yy-mm-dd', new Date());
				 $("#calendar2").val(today);
				 const t=new Date().getTime()-2*24*3600*1000;
				 var last2day = $.datepicker.formatDate('yy-mm-dd', new Date(t));
				 $("#calendar1").val(last2day);
				 hot_stock_uri = '/hot_stock?datetimeGT='+last2day+"&datetimeET="+today;

				 // 次级三买
				 $("#thirdCijiDiv").dialog({
					 modal: false,
					 autoOpen: false,
					 width: 1400,
					 height: 700,
				 });
				 thirdCijiTableObj = $('#thirdCijiTable').DataTable({
					 ajax: {
						 url: baseUrl + focus_on_uri,   // 你的后端数据接口地址
						 dataSrc: function (json) {
							 cijiChanTable = json.data; // 将数据保存到全局变量
							 return json.data; // 返回给 DataTable 进行渲染
						 }
					 },
					 columns: [
						 {
							 "data": null,
							 "width": '30px',
							 "render": function (data, type, row, meta) {
								 return meta.row + 1;
							 }
						 },
						 {data: 'code'},
						 { data: 'starttime',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd')
							}
						},
						 { data: 'endtime',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd')
							}
						},
						 {data: 'high'},
						 {data: 'low'},
						 { data: 'focus_time',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd')
							}
						 },
						 {data: 'focus_price'},
						 {data: 'focus_type'},
						 {data: 'is_confirm',render: function(data, type, row) {
								return is_confirm_type[data];
							}
						 },
						 {
							"data": null,
							"title": "操作", // 可选，表头自定义
							"orderable": false, // 不排序
							"render": function(data, type, row, meta){
								// data/row 就是当前行的数据
								var index = meta.row+1;
								// 假设row有id主键
								return '<button class="thirdBS-btn-item" data-index="'+index+'" data-id="'+row.code+'">查看</button>'
										+'<button class="thirdBS-btn-confirm" data-id2="'+row.focus_time+'" data-id="'+row.code+'">确定</button>'
										+'<button class="thirdBS-btn-cancel" data-id2="'+row.focus_time+'"  data-id="'+row.code+'">取消</button>';
							}
						 }
					 ]
				 })
				 //三买卖窗口
				 $("#thirdBSDiv").dialog({
					 modal: false,
					 autoOpen: false,
					 width: 1400,
					 height: 700,
					 create: function(event, ui) {
						var dialog = $(this).closest(".ui-dialog");
						// 最下化按钮
						$("<button class='ui-dialog-titlebar-min'><span style='font-weight: bold;'>—</span></button>")
						  .appendTo(dialog.find(".ui-dialog-titlebar"))
						  .click(function() {
							  thirdBSTableStyle = dialog.attr('style');
							  dialog.css({ height: "42px" });
							  dialog.find(".ui-dialog-content").css({ height: "calc(0%)" });
							  dialog.find(".ui-dialog-content").css({ padding: "0" });
						  });
						// 添加最大化按钮
						$("<button class='ui-dialog-titlebar-max'>🗖</button>")
						  .appendTo(dialog.find(".ui-dialog-titlebar"))
						  .click(function() {
							  dialog.css({ width: "100%", height: "100%", top: 0, left: 0 });
							  dialog.find(".ui-dialog-content").css({ height: "100%", width:'100%' });
							  dialog.find(".ui-dialog-content").css({ padding: "2px 1em" });
						  });
						//复原窗口 按钮
						$("<button class='ui-dialog-titlebar-reset'>❐</button>")
						  .appendTo(dialog.find(".ui-dialog-titlebar"))
						  .click(function() {
							  dialog.attr('style', thirdBSTableStyle);
							  // dialog.css({height: "700px", width: "1400px",top: "19px", left: "60px" });
							  dialog.find(".ui-dialog-content").css({ height: "100%", width:'100%' });
							  dialog.find(".ui-dialog-content").css({ padding: "2px 1em" });
						  });

					 }
				 })
				 thirdBSTableObj = $('#thirdBSTable').DataTable({
					 ajax: {
						 url: baseUrl + thirdBS_uri,   // 你的后端数据接口地址
						 // dataSrc: ''              // 假如返回的是数组，不是对象最外层data才这样写
					 },
					 columns: [
						 {
							 "data": null,
							 "width": '30px',
							 "render": function(data, type, row, meta){
							  	return meta.row+1;
							 }
						 },
						 {data: 'Ticker'},
						 { data: 'startDate',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd HH:mm')
							}
						},
						 { data: 'endDate',
							render: function(data, type, row) {
								return formatDate(data, 'yyyy-MM-dd HH:mm')
							}
						},
						 {data: 'Line_Type'},
						 {data: 'class_type'},
						 {data: 'endPrice'},
						 {data: 'rate'},
						 {
							"data": null,
							"title": "操作", // 可选，表头自定义
							"orderable": false, // 不排序
							"render": function(data, type, row, meta){
								// data/row 就是当前行的数据
								// 假设row有id主键
								return '<button class="thirdBS-btn" data-id="'+row.Ticker+'">查看</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="0">0</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="1">1</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="2">2</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="3">3</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="4">4</button>'+
										'<button class="thirdBS-btn-rate" data-id="'+row.Ticker+'" data-linetype="'+row.Line_Type+'" data-startdate="'+row.startDate+'" data-rate="5">5</button>';
							}
						}

					 ],
					 processing: true, // 开启DataTables内置的“正在处理...”动画
					 language: {
						processing: "数据加载中..." // 可自定义文字
					 }
				 });
				 var minFilter = { 2: null, 3: null, 4: null, 5: null,6: null, 7: null, 8: null}; // 键为表的列下标
				 $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
					// 遍历有filter的列
					for(var col in minFilter){
						var minValue = minFilter[col];
						if(minValue !== null && minValue !== ''){
							// data[col] 是表格当前渲染行的指定列，通常被渲染后带逗号要去掉
							var cellValue = Number(data[col].replace(/,/g,''));
							if (isNaN(cellValue) || cellValue <= Number(minValue)) {
								return false; // 不通过筛选
							}
						}
					}
					return true; // 全部通过
				});

				 // 监听三个列的输入（Volume=第2列，MA5=第3列，MA10=第4列）
				 $('#myTable thead tr:eq(0) th').each(function(i) {
					var $input = $('input', this);
					if ($input.length) {
						$input.on('keyup change', function() {
							// 把相应列的最小值记录下来
							minFilter[i] = cleanNumber(this.value);
							myTableObj.draw();
						});
					}
				});
				 $(document).on('click', '.edit-btn', function(){
					var id = $(this).data('id');
					// 你的编辑逻辑
					var chart = window.tvWidget.activeChart();
					chart.setSymbol(id)
					 chart.setResolution('1D')
					 $("#hotStock").dialog('close');
				 });
				 $(document).on('click', '.thirdBS-btn', function(){
					var id = $(this).data('id');
					// 你的编辑逻辑
					var chart = window.tvWidget.activeChart();
					chart.setSymbol(id);
					$("#hotStock").dialog('close');
				 });
				 $(document).on('click', '.thirdBS-btn-rate', function(){
					var id = $(this).data('id');
					var linetype = $(this).data('linetype');
					var startDate = $(this).data('startdate') / 1000;
					var rate = $(this).data('rate');
					var chart = window.tvWidget.activeChart();
					const resolution = chart.resolution();
					// 你的编辑逻辑
					 $.ajax({
						 url: baseUrl + '/chan_rate',
						 type: 'GET',
						 dataType: 'json', // 指定返回数据类型为 JSON
						 data: {
							 resolution: resolution,
							 symbol: id,
							 line_type: linetype,
							 start_date: startDate,
							 rate: rate
						 },
						 success: function (response) {
							 $('#popup').html('更新关注度，成功！');
							 $('#popup').fadeIn();
							 // 设定3秒后自动关闭
							 setTimeout(function() {
								 $('#popup').fadeOut();
								 thirdBSTableObj.ajax.url(baseUrl + thirdBS_uri).load();
							 }, 500);
						 },
						 error: function () {
						 }
					 });

				 });
				 $(document).on('click', '.thirdBS-btn-confirm', function(){
					var id = $(this).data('id');
					var focus_time = $(this).data('id2')/1000;
					// 你的编辑逻辑
					 $.ajax({
						 url: baseUrl + '/focus_on_confirm',
						 type: 'GET',
						 dataType: 'json', // 指定返回数据类型为 JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 $('#popup').html('确认成功！');
							 $('#popup').fadeIn();
							 // 设定3秒后自动关闭
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
							 thirdCijiTableObj.ajax.url(baseUrl + focus_on_uri).load();
						 },
						 error: function () {
						 }
					 });
				 });
				 $(document).on('click', '.thirdBS-btn-cancel', function(){
					var id = $(this).data('id');
					var focus_time = $(this).data('id2')/1000;
					// 你的编辑逻辑
					 $.ajax({
						 url: baseUrl + '/focus_on_cancel',
						 type: 'GET',
						 dataType: 'json', // 指定返回数据类型为 JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 $('#popup').html('取消成功！');
							 $('#popup').fadeIn();
							 // 设定3秒后自动关闭
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
							 thirdCijiTableObj.ajax.url(baseUrl + focus_on_uri).load();
						 },
						 error: function () {
						 }
					 });
				 });

				 $(document).on('click', '.thirdBS-btn-item', function(){
					 var id = $(this).data('id');
					 var index = $(this).data('index');
					// 你的编辑逻辑
					var chart = window.tvWidget.activeChart();
					chart.setSymbol(id);
					cijiChanTableIndex = index-1;
					renderCijiChanItem();
				 });
				 $(document).on('click', '.thirdBS-btn-item-preview', function(){
					 cijiChanTableIndex--;
					 if(cijiChanTableIndex<0){
						 cijiChanTableIndex=0;
						 return ;
					 }
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 // 你的编辑逻辑
					 var chart = window.tvWidget.activeChart();
					 chart.setSymbol(id);
					 renderCijiChanItem();
					 //绘制缠论线
					 setTimeout(function(){
						 const resolution = chart.resolution();
						 var symbol = id;
						 console.info(resolution,symbol);
						 clearAllLines(chart);
						 drawLines(chart, symbol, resolution);
					 }, 2000);
				 });
				 $(document).on('click', '.thirdBS-btn-item-confirm', function(){
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 var focus_time = item.focus_time/1000;
					// 你的编辑逻辑
					 $.ajax({
						 url: baseUrl + '/focus_on_confirm',
						 type: 'GET',
						 dataType: 'json', // 指定返回数据类型为 JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 $('#popup').html('确认成功！');
							 $('#popup').fadeIn();
							 // 设定3秒后自动关闭
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
						 },
						 error: function () {
						 }
					 });
				 });
				 $(document).on('click', '.thirdBS-btn-item-cancel', function(){
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 var focus_time = item.focus_time/1000;
					// 你的编辑逻辑
					 $.ajax({
						 url: baseUrl + '/focus_on_cancel',
						 type: 'GET',
						 dataType: 'json', // 指定返回数据类型为 JSON
						 data: {
							 datetime: focus_time,
							 code: id
						 },
						 success: function (response) {
							 // alert("取消成功！")
							 $('#popup').html('取消成功！');
							 $('#popup').fadeIn();
							 // 设定3秒后自动关闭
							 setTimeout(function() {
								 $('#popup').fadeOut();
							 }, 2000);
						 },
						 error: function () {
						 }
					 });
				 });
				 $(document).on('click', '.thirdBS-btn-item-next', function(){
					 cijiChanTableIndex++;
					 if(cijiChanTableIndex>=cijiChanTable.length){
						 cijiChanTableIndex=cijiChanTable.length-1;
						 return ;
					 }
					 var item = cijiChanTable[cijiChanTableIndex];
					 var id = item.code;
					 // 你的编辑逻辑
					 var chart = window.tvWidget.activeChart();
					 chart.setSymbol(id);
					 renderCijiChanItem();
					 //绘制缠论线
					 setTimeout(function(){
						 const resolution = chart.resolution();
						 var symbol = id;
						 console.info(resolution,symbol);
						 clearAllLines(chart);
						 drawLines(chart, symbol, resolution);
					 }, 2000);
				 });
			 })
			function formatDate(date, format) {
				if (!(date instanceof Date)) {
					date = new Date(date); // 支持时间戳或字符串
				}
				const map = {
					'yyyy': date.getFullYear(),
					'MM': ('0' + (date.getMonth() + 1)).slice(-2),
					'dd': ('0' + date.getDate()).slice(-2),
					'HH': ('0' + date.getHours()).slice(-2),
					'mm': ('0' + date.getMinutes()).slice(-2),
					'ss': ('0' + date.getSeconds()).slice(-2)
				};
				return format.replace(/yyyy|MM|dd|HH|mm|ss/g, (key) => map[key]);
			}
			function cleanNumber(str) {
			  // 去除所有空格和逗号
			  var cleaned = str.replace(/[\s,]/g, '');
			  // 转成数字
			  return Number(cleaned);
			}
			function getParameterByName(name) {
				name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
				var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
					results = regex.exec(location.search);
				return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			function clearAllLines(chart){
				for(var id in chanLun_lines){
					if(chanLun_lines[id]==null){
						continue
					}
					chart.removeEntity(chanLun_lines[id]);
				}
                chanLun_lines = []
			}
			function createText(chart, time, price, text){
				 var id = chart.createShape(
					  {
						time: time, // 时间戳/或bar索引
						price: price,       // 价格
					  },
					  {
						shape: 'text',
						text: text,//'三买信号',
						lock: true,
					  }
					)
				 if(id){
					 chanLun_lines.push(id);
				 }
			}
			function drawLines(chart, symbol, resolution){
				$.ajax({
					url: baseUrl+'/chan',
					type: 'GET',
					dataType: 'json', // 指定返回数据类型为 JSON
					data: {
						symbol: symbol,
						resolution: resolution
					},
					success: function(response) {
						// chart.removeAllStudies();
						// chart.removeEntity(test);
						// console.log('Success:', response);
						for(var i in response){
							const item = response[i];
							if (item.class_type){
								if(item.class_type=='Third Buy'){
									if(item.Line_Type == 'down'){
										createText(chart, item.endDate, item.endPrice, item.class_type);
									}else{
										createText(chart, item.startDate, item.startPrice, item.class_type);
									}
								}
								if(item.class_type=='Third Sell'){
									if(item.Line_Type == 'up'){
										createText(chart, item.endDate, item.endPrice, item.class_type);
									}else{
										createText(chart, item.startDate, item.startPrice, item.class_type);
									}
								}
								if (item.class_type=='First Sell' || item.class_type=='First Buy'){
									createText(chart, item.endDate, item.endPrice, item.class_type);
								}
							}
							var lineId = chart.createMultipointShape(
							  [
								{ time: item.startDate, price: item.startPrice },
								{ time: item.endDate, price: item.endPrice },
							  ],
							  {
								shape: 'trend_line',
								overrides: {
								  linecolor: '#FF0000',
								  linewidth: 2,
								},
								lock: true,
								disableSelection: true,
								disableSave: true,
								disableUndo: true,
								text: item.Line_Type,
							  });
							chanLun_lines.push(lineId);
						}
					},
					error: function(xhr, status, error) {
						console.error('Error:', error);
					}
				});
			}
			function renderCijiChanItem(){
				if(cijiChanTableIndex>-1){
					var item = cijiChanTable[cijiChanTableIndex];
					if(item){
						var trs = $("#cijiChanTable");
						trs.html("");
						const colume_list = [
								{"name":"code", "type": 'string'},
								{"name":"focus_time", "type": 'date'},
								{"name":"period", "type": 'string'},
								{"name":"is_confirm", "type": 'emun'}
						];
						for(var i in colume_list){
							var key = colume_list[i].name;
							var type= colume_list[i].type;
							var value = item[key]
							if(type == 'date'){
								value = formatDate(value, 'yyyy-MM-dd')
							}else if(type == 'emun'){
								value = is_confirm_type[value];
							}
							var td = $("<td>").html(value);
							trs.append(td);
						}
						var count = "&nbsp; "+(cijiChanTableIndex+1)+"/"+cijiChanTable.length
						var td=$("<td>").html(count);
						trs.append(td);
					}
				}
			}
			function initOnReady() {
				console.info(TradingView.version());
				var datafeedUrl = baseUrl;//"http://127.0.0.1:8000";
				// var datafeedUrl = "https://demo-feed-data.tradingview.com";
				var customDataUrl = getParameterByName('dataUrl');
				if (customDataUrl !== "") {
					datafeedUrl = customDataUrl.startsWith('https://') ? customDataUrl : `https://${customDataUrl}`;
				}

				var widget = window.tvWidget = new TradingView.widget({
					// debug: true, // uncomment this line to see Library errors and warnings in the console
					fullscreen: true,
					symbol: 'sh.000001',
					// interval: '5',
					interval: '1D',
					container: "tv_chart_container",

					//	BEWARE: no trailing slash is expected in feed URL
					datafeed: new Datafeeds.UDFCompatibleDatafeed(datafeedUrl, undefined, {
						maxResponseLength: 1000,
						expectedOrder: 'latestFirst',
					}),
					library_path: "charting_library/",
					locale: getParameterByName('lang') || "en",
					timezone: "UTC",
					time_scale: {
						timeVisible: true,
						secondsVisible: true,
					},
					// disabled_features: ["use_localstorage_for_settings"],
					disabled_features: [],
					enabled_features: ["study_templates","use_localstorage_for_settings"],
					// charts_storage_url: 'https://saveload.tradingview.com',
					charts_storage_api_version: "1.1",
					client_id: 'tradingview.com',
					user_id: 'public_user_id',
					theme: getParameterByName('theme'),
					debug: false,
					// debug: true,
					// 时间格式化
					custom_formatters: {
						timeFormatter: { //分钟格式化
							format: (date) => {
								const _format_str = '%h:%m';
								return _format_str
										.replace('%h', date.getUTCHours(), 2)
										.replace('%m', date.getUTCMinutes(), 2)
										.replace('%s', date.getUTCSeconds(), 2);
							}
						},
						dateFormatter: { //年月日格式化
							format: (date) => {
								return date.getUTCFullYear() + '/' + (date.getUTCMonth() + 1) + '/' + date.getUTCDate();
							}
						},
					},
					context_menu: {
						items_processor: function(items, actionsFactory, params) {
							 console.log(`Menu name is:`);
							 const newItem = actionsFactory.createAction({
								actionId: 'hello-world',
								label: 'Say Hello',
								onExecute: function() {
								   alert('Hello World');
								},
							 });
							 items.unshift(newItem);
							 return Promise.resolve(items);
						},
				    }
				});
				widget.onChartReady(() => {
					console.info("dzm");
					const chart = widget.activeChart(); // 假设 widget 是你的 Charting Library 实例
					/*
					const startTime = Math.floor(new Date('2025-01-22T00:00:00Z').getTime() / 1000);
					const endTime = Math.floor(new Date('2025-03-01T00:00:00Z').getTime() / 1000);

					// 创建线段
					var test = chart.createMultipointShape(
					  [
						{ time: startTime, price: 200 },
						{ time: endTime, price: 212 },
					  ],
					  {
						shape: 'trend_line',
						overrides: {
						  linecolor: '#FF0000',
						  linewidth: 2,
						},
						lock: true,
						disableSelection: true,
						disableSave: true,
						disableUndo: true,
						text: "text",
					  })*/
				  // widget.activeChart().setResolution('5');  // 显式设置为 5 分钟
					//add chanThoeryButton
					const chartContainer = document.getElementById('tv_chart_container');
					//---------------------次级三买-----------------------
					const third_flag = document.createElement('button');
					third_flag.id = 'third_flag';
					third_flag.innerText = '次级三买';
					chartContainer.appendChild(third_flag);
					third_flag.addEventListener('click', function() {
						var last2day = $("#calendar1").val();
						var tt=$("#calendar2").val();
						const resolution = chart.resolution();
						focus_on_uri = '/focus_on?datetimeGT='+last2day+"&datetimeET="+tt+"&resolution="+resolution;
						thirdCijiTableObj.ajax.url(baseUrl + focus_on_uri).load();
						$("#thirdCijiDiv").dialog('open');
						cijiChanTableIndex = 0;
						renderCijiChanItem();
					});
					// --------------------三买/卖--------------------
					const thirdBS = document.createElement('button');
					thirdBS.id = 'thirdBS';
					thirdBS.innerText = '三买/卖';
					chartContainer.appendChild(thirdBS);
					thirdBS.addEventListener('click', function() {
						var last2day = $("#calendar1").val();
						var tt=$("#calendar2").val();
						const resolution = chart.resolution();
						var symbol = chart.symbol();
						symbol = symbol.split(":")[1];
						// console.info(resolution,symbol);
						thirdBS_uri = '/third_bs_query?datetimeGT='+last2day+"&datetimeET="+tt+"&resolution="+resolution;
						thirdBSTableObj.ajax.url(baseUrl + thirdBS_uri).load();
						$("#thirdBSDiv").dialog('open');
						// myTableObj.ajax.reload();
					})
					// --------------------缠论-线--------------------
					const button = document.createElement('button');
					button.id = 'chanThoery';
					button.innerText = '缠论-线';
					// button.style.position = 'absolute';
					// button.style.top = '10px';
					// button.style.right = '10px';

					// 添加点击事件监听器
					button.addEventListener('click', function() {
						const resolution = chart.resolution();
						var symbol = chart.symbol();
						if (symbol.indexOf(":")){
							symbol = symbol.split(":")[1]
						}
						console.info(resolution,symbol);
						clearAllLines(chart);

						drawLines(chart, symbol, resolution);
					});
					chartContainer.appendChild(button);
				});
			};


			window.addEventListener('DOMContentLoaded', initOnReady, false);
		</script>

	</head>

	<body style="margin:0px;">
		<div id="tv_chart_container"></div>
		<div id="calender">
			开始时间：
			<input type="text" id="calendar1" style="width:88px">
			结束时间：
			<input type="text" id="calendar2" style="width:88px">
		</div>
		<div id="cijiChanDiv">
			<table style="border-collapse: collapse;float: left">
				<tr id="cijiChanTable">
					<td>次级三买操作区</td>
				</tr>
			</table>
			<table style="border-collapse: collapse;float: right">
				<tr>
					<td><button class="thirdBS-btn-item-preview">《&nbsp;</button></td>
					<td><button class="thirdBS-btn-item-confirm">确定&nbsp;</button></td>
					<td><button class="thirdBS-btn-item-cancel">取消</button></td>
					<td><button class="thirdBS-btn-item-next">&nbsp;》</button></td>
				</tr>
			</table>
		</div>
		<div id="thirdBSDiv" title="三买/卖" style="display:none;padding: 1px 1em">
			  <div style="background-color: #fff">
				  <table id="thirdBSTable" class="display" width="100%">
					  <thead>
						<tr>
							<th>序号</th>
							<th>代码</th>
							<th>开始时间</th>
							<th>结束时间</th>
							<th>线段类型</th>
							<th>买卖类型</th>
							<th>结束价格</th>
							<th><span title="重要程度:0-5">重要度</span></th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody>
						<!-- Ajax 渲染，这里可以留空 -->
					</tbody>
				  </table>
			  </div>
			</div>
		<div id="thirdCijiDiv" title="次级三买" style="display:none;">
			  <div style="background-color: #fff">
				  <table id="thirdCijiTable" class="display" width="100%">
					  <thead>
						<tr>
							<th>序号</th>
							<th>代码</th>
							<th>区间开始</th>
							<th>区间结束</th>
							<th>区间顶</th>
							<th>区间底</th>
							<th>关注时间</th>
							<th>关注价格</th>
							<th>类型</th>
							<th>明确</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody>
						<!-- Ajax 渲染，这里可以留空 -->
					</tbody>
				  </table>
			  </div>
			</div>
		<div id="popup" style="z-index: 1002">这是一个右下角弹窗！</div>
	</body>

</html>
